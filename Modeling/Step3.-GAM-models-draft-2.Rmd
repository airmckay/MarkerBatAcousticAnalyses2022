---
title: "Marker bat acoustic models draft 2"
output:
  word_document: default
  html_document: default
date: "2022-11-28"
editor_options: 
  chunk_output_type: console
---
# **Main objectives**

Model total nightly bat activity for all ground level detectors 
Create a binary response (bat activity per site per night = 1 or 0) model and a count response model 
Plot predictions:

- One predicition dataset with time and wind speeds set to a single average value
  - Plot the difference between habitats over time (nights in the season )
  
- One prediction data set with a full range of time and wind speeds
  - Plot the predicted cut off temperatures and wind speeds for total bat activity 

------------------------------------------------------------------------------------

------------------------------------------------------------------------------------
```{r, results = FALSE}

# set project working directory according to the user system info 
# Otherwise, all the data (inputs and outputs, including figures) can be stored on a shared OneDrive folder

user <- Sys.info()['effective_user'] 
user
# this should print your nmbu user name - "apmc" in my case. 

wd <- getwd()
wd
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/Documents/1. PhD_Main/GitHub_link/MarkerBatAcousticAnalyses/MarkerBatAcousticAnalyses2022"


##########################################################
#### Work environment set up ####
##########################################################
library(knitr)
library(data.table)
library(tidyverse)
library(beepr)
library(lubridate)
library(purrr)
#renv::install("rstudio/renv")
library(renv)
library(stringr)
library(janitor)
library(anytime)
library(kableExtra)
library(papeR)
library(skimr)
library(vtable)
library(gratia)
library(DHARMa)
library(mgcv)
library(tidymv)

##########################################################
#### Import data, set up directories   ####
##########################################################

# All input data can be found on a shared OneDrive folder - we can both share the same input folder but we should have different Output folders. 

# for Katrine 
#input <- ""

# for Reed 
input <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/2. Marker 2019-2020/Marker 2022/SecondDraftAnalyses/Input/forModels"

dataset1 <- "guild_behavior_summarytable_site.csv" 
# df2C for the dataset aggregated by guild and bahavior from Marker aggregated to night_all bats
dataset2 <- "totalbatpass_summarytable_withbinary_batpass_night_aggregated_site data.csv"
# df2C for the dataset aggregated to all batsa from Marker aggregated to night_all bats
dataset3 <- "nightlyaggregated_zeros_binary_behavior and guild.csv"
# dataset aggregated to guild and behavior before being table transformed 
dataset4 <- "nightlyaggregatedMarker2020_totalbats_zeroinserted_weather_binary.csv"
# dataset aggregated to night by total bats before table transformed 
dataset5 <- "guild_behavior_batpass_summarytable_trimmed MRE social and met tower.csv"


path1 <- str_c(input, "/", dataset1)
path2 <- str_c(input, "/", dataset2)
path3 <- str_c(input, "/", dataset3)
path4 <- str_c(input, "/", dataset4)
path5 <- str_c(input, "/", dataset5)

bats_gb <- read_csv(path1) # 11412 obs of 20 variables 
bats_tot <- read.csv(path2) # # 951 obs of 18 variables variables
bats_gb_simple <- read.csv(path3) # 11412 obs of 17 vars 
bats_tot_simple <- read.csv(path4) # 951 obs of 15 variables
bats_gb_trim <- read.csv(path5) # 4866 obs of 20 variables 

# for Reed
output <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/2. Marker 2019-2020/Marker 2022/SecondDraftAnalyses/Reed/Outputs"

# for Katrine 
#output <- ""

## 
 file.name <- "Step3.Marker bat acoustics models draft 2"
# 
 todays_date <- Sys.Date()
# 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
 dir.name
# 
# dir.create(dir.name) # be careful not to recreate existing directories 

output_today <- dir.name
output_today

```

### Recommended Youtube videos on GAM to understand the R code below

 https://www.youtube.com/watch?v=q4_t8jXcQgc
 https://www.youtube.com/watch?v=sgw4cu8hrZM&t=4038s
 
--------------------------------------------------------------------------------

The "bats_tot" dataset 
Nightly aggregated total bat activity 

# Preparing the dataset for modeling 
Starting with bats total 
```{r, echo = FALSE}
str(bats_tot) #Seems like our factor variables are back to 'chr' variables again....
names(bats_tot)
#Housekeeping to make character variables factors
bats_tot$Habitat <- factor(bats_tot$Habitat)
bats_tot$Locality <- factor(bats_tot$Locality)
bats_tot$Site <- factor(bats_tot$Site)
bats_tot$Facility <- factor(bats_tot$Facility) 
bats_tot$jnight <- yday(bats_tot$night)

#Explore relationships and look check for outliers again
#windows()
par(mfrow = c(3,2))
plot(bats_tot$jnight, bats_tot$batpass_prop)            
plot(bats_tot$temp_mean, bats_tot$batpass_prop)
plot(bats_tot$temp_max, bats_tot$batpass_prop)
plot(bats_tot$wind_mean, bats_tot$batpass_prop)
plot(bats_tot$wind_max, bats_tot$batpass_prop)

#The batspass_prop variable is "number of hours with >0 batpass" / "total number of observation hours" - per night
#This is your response, but often proportion variables cannot be modelled directly 
```
 
### Steps to prepare binary response (1=batpass, 0 = no batpass)
```{r}
# This is now only nightly aggregated so I am not sure this has the same intended effect... 

bats_tot$yes_batpass <- bats_tot$batpass01_sum   #batpass01_sum is sum of '1' values in batpass01, i.e. number of observ. hours per night when batpass recorded
bats_tot$no_batpass <- bats_tot$batpass01_length - bats_tot$batpass01_sum #batpass01_length is number of observ. hours per night

summary(bats_tot)


## Convert all bat passes over 50 per night to 50

#Make a new column in the dataset
bats_tot$batpass50 <- bats_tot$Batpass_sum

# reassign batpass values over 50 to 50
bats_tot$batpass50[bats_tot$Batpass_sum>50] <- 50


### Drop the met tower 

df <- bats_tot %>% filter(Habitat != "MeteorologicalTower") %>% droplevels()
summary(df)
```

--------------------------------------------------------------------------------
--------------------------------------------------------------------------------


# Binary response 
### s(Locality, bs = "re")
### Removed the temp * wind interaction 
```{r}
m1 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k = 30) +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean, k = 15), 
              data = df, method = "REML",                 
              family = binomial, select = TRUE)                

summary(m1) 

## Diagnostics ## 
#windows()
par(mfrow = c(2,2))
gam.check(m1)           
gam.check(m1, rep=500)  

#rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m1 <- sum( residuals(m1, "pearson")^2 ) / m1$df.residual
overdispersion.m1

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```
## Notes on model fit
A bit under dispersed and the K values do not fit perfectly but I guess it will work for now. 

### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m1 bats total.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m1, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)
draw(m1, scales ="free")         #function 'draw' is from package 'gratia'
draw(m1, scales ="fixed")

dev.off() 

```


# Make prediction figures
### Better visualize the wind and temperature cutoffs
 Make make different prediction datasets:
 - One with a single averaged value for wind and temperature
 - One with a range of wind and temperature values
 Also test using different turbine localities (turbines 2 and 9)

```{r}

names(df)
levels(df$Locality)

# Quick summary in the differences in bat activity recorded at the different sites
ggplot(df) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))
# -----------------------------------------------------------------------------
# Wind and temperature are a range 

# Turbine 9
newdata2 <- expand.grid(temp_mean= c(4, 6, 8,10, 12, 14, 16, 18, 20),
                          wind_mean = c(2, 4, 6, 8, 10, 12, 14, 16),
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))


# Turbine 2
newdata2a <- expand.grid(temp_mean= c(4, 6, 8,10, 12, 14, 16, 18, 20),
                          wind_mean = c(2, 4, 6, 8, 10, 12, 14, 16),
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))


############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m1, newdata = newdata1, type = "response")
fit1df <- data.frame(newdata1, fit1)
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m1, newdata = newdata1a, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
summary(fit1adf)

# -----------------------------------------------------------------------------
# Wind and temperature are a range 

# Turbine 9
fit2 <- predict.gam(m1, newdata = newdata2, type = "response")
fit2df <- data.frame(newdata2, fit2)
summary(fit2df)

# Turbine 2
fit2a <- predict.gam(m1, newdata = newdata2a, type = "response")
fit2adf <- data.frame(newdata2a, fit2a)
summary(fit2adf)

```

# Plotting predictions

## Comparing habitats across seasons
```{r}
# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit1)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9")

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit1a)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2")

## Add confidence intervals, clean up the background 
```

## Looking for temperature and wind speed cut offs 

```{r}

# Using colored points to represent average nightly wind speeds and temperatures... perhaps there is a more meaningful way to represent this. 

# Turbine 9 - wind 
fit2df %>% ggplot(aes(x=jnight, y=fit2)) +
  geom_point(aes(color = wind_mean)) + ggtitle("Turbine 9")

# Turbine 9 - temp 
fit2df %>% ggplot(aes(x=jnight, y=fit2)) +
  geom_point(aes(color = temp_mean)) + ggtitle("Turbine 9")

# -----------------------------------------------------------------------------

# Turbine 2 - wind
fit2adf %>% ggplot(aes(x=jnight, y=fit2a)) +
  geom_point(aes(color = wind_mean))  + ggtitle ("Turbine 2")

# Turbine 2 - temp 
fit2adf %>% ggplot(aes(x=jnight, y=fit2a)) +
  geom_point(aes(color = temp_mean))  + ggtitle ("Turbine 2")

# -----------------------------------------------------------------------------

# Temp is the response variable 
# Turbine 9
fit2df %>% ggplot(aes(x=temp_mean, y=fit2)) +
  geom_point() + ggtitle("Turbine 9")

# Turbine 2
fit2adf %>% ggplot(aes(x=temp_mean, y=fit2a)) +
  geom_point()  + ggtitle ("Turbine 2")


# Wind is the response variable 
# Turbine 9
fit2df %>% ggplot(aes(x=wind_mean, y=fit2)) +
  geom_point() + ggtitle("Turbine 9")

# Turbine 2
fit2adf %>% ggplot(aes(x=wind_mean, y=fit2a)) +
  geom_point()  + ggtitle ("Turbine 2")

## Not terribly insightful - Could try plotting predictions for each temperature degree change or wind speed change? 
## Not seeing much of a difference between the turbines so far. 
# low wind, high temperature 
# high wind, low temperature
# low wind, low temperature
# high wind, high temperature 

## Still does not help with plotting cut offs though... 

```

--------------------------------------------------------------------------------

--------------------------------------------------------------------------------

# m2
### Count response 
```{r}
m2 <- gam(batpass50 ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k = 90) +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean, k = 20) ,                      
              data = df, method = "REML",                 
              family = nb(), select=TRUE)                

summary(m2) 
```


```{r}
windows()
par(mfrow = c(2,2))
gam.check(m2)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m2, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m2 <- sum( residuals(m2, "pearson")^2 ) / m2$df.residual
overdispersion.m2

# From Katrine's Step3B GAM modelling script: 
#[1] 1.260461    #slightly overdispersed but horribly 

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m2 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m2, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m2, scales ="free")         #function 'draw' is from package 'gratia'
draw(m2, scales ="fixed")
 
dev.off() 

```

The K values are slightly off but the dispersion is not bad and the diagnostic plots looks okay

--------------------------------------------------------------------------------

# Make prediction figures
### Better visualize the wind and temperature cutoffs
 Make make different prediction datasets:
 - One with a single averaged value for wind and temperature
 - One with a range of wind and temperature values
 Also test using different turbine localities (turbines 2 and 9)

```{r}

names(df)
levels(df$Locality)

# Quick summary in the differences in bat activity recorded at the different sites
ggplot(df) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))
# -----------------------------------------------------------------------------
# Wind and temperature are a range 

# Turbine 9
newdata2 <- expand.grid(temp_mean= c(4, 6, 8,10, 12, 14, 16, 18, 20),
                          wind_mean = c(2, 4, 6, 8, 10, 12, 14, 16),
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))


# Turbine 2
newdata2a <- expand.grid(temp_mean= c(4, 6, 8,10, 12, 14, 16, 18, 20),
                          wind_mean = c(2, 4, 6, 8, 10, 12, 14, 16),
                          Habitat = levels(df$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(df$jnight), max(df$jnight), 1))


############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m2, newdata = newdata1, type = "response")
fit1df <- data.frame(newdata1, fit1)
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m2, newdata = newdata1a, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
summary(fit1adf)

# -----------------------------------------------------------------------------
# Wind and temperature are a range 

# Turbine 9
fit2 <- predict.gam(m2, newdata = newdata2, type = "response")
fit2df <- data.frame(newdata2, fit2)
summary(fit2df)

# Turbine 2
fit2a <- predict.gam(m2, newdata = newdata2a, type = "response")
fit2adf <- data.frame(newdata2a, fit2a)
summary(fit2adf)

```

# Plotting predictions

## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit1)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9")

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit1a)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2")

## Add confidence intervals, clean up the background 
```

## Looking for temperature and wind speed cut offs 

```{r}

# Using colored points to represent average nightly wind speeds and temperatures... perhaps there is a more meaningful way to represent this. 

# Turbine 9 - wind 
fit2df %>% ggplot(aes(x=jnight, y=fit2)) +
  geom_point(aes(color = wind_mean)) + ggtitle("Turbine 9")

# Turbine 9 - temp 
fit2df %>% ggplot(aes(x=jnight, y=fit2)) +
  geom_point(aes(color = temp_mean)) + ggtitle("Turbine 9")

# See what this looks like for bat pass > 0 
# Turbine 9 - temp 
fit2df %>% dplyr::filter(fit2 > 10) %>%  ggplot(aes(x=jnight, y=fit2)) +
  geom_point(aes(color = temp_mean)) + ggtitle("Turbine 9")

fit2df %>% ggplot(aes(x=jnight, y=fit2)) +
  geom_point(aes(color = temp_mean)) + ylim(c(10,150)) + ggtitle("Turbine 9")

## I want to try and make this figure but make it a line plot with predictions for a series of temperatures... .

# -----------------------------------------------------------------------------

# Turbine 2 - wind
fit2adf %>% ggplot(aes(x=jnight, y=fit2a)) +
  geom_point(aes(color = wind_mean))  + ggtitle ("Turbine 2")

# Turbine 2 - temp 
fit2adf %>% ggplot(aes(x=jnight, y=fit2a)) +
  geom_point(aes(color = temp_mean))  + ggtitle ("Turbine 2")

# -----------------------------------------------------------------------------

# Temp is the response variable 
# Turbine 9
fit2df %>% ggplot(aes(x=temp_mean, y=fit2)) +
  geom_point() + ggtitle("Turbine 9")

# Turbine 2
fit2adf %>% ggplot(aes(x=temp_mean, y=fit2a)) +
  geom_point()  + ggtitle ("Turbine 2")


# Wind is the response variable 
# Turbine 9
fit2df %>% ggplot(aes(x=wind_mean, y=fit2)) +
  geom_point() + ggtitle("Turbine 9")

# Turbine 2
fit2adf %>% ggplot(aes(x=wind_mean, y=fit2a)) +
  geom_point()  + ggtitle ("Turbine 2")

## These last few plots are a bit more helpful. 

```


--------------------------------------------------------------------------------
Only for the sake of testing - use a similar model that does not have an interaction between jnight and habitat to see if the results are similar. 






---
title: "Marker bat acoustic models draft 2"
output:
  word_document: default
  html_document: default
date: "2022-11-28"
---
### Notes from meeting with Katrine 29.11.2022

1. For the total bat data set, with y = binary nightly bat activity 
------------------------------------------------------------------------------------
a. Adjust the k value for the bats_tot model to find one that better suits the data
b. Illustrate the wind/temperature cutoffs. 
- At some point, it may be necessary to re-aggregate the weather data to Facility rather than across both facilities
------------------------------------------------------------------------------------
```{r, results = FALSE}

# set project working directory according to the user system info 
# Otherwise, all the data (inputs and outputs, including figures) can be stored on a shared OneDrive folder

user <- Sys.info()['effective_user'] 
user
# this should print your nmbu user name - "apmc" in my case. 

wd <- getwd()
wd
# "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/Documents/1. PhD_Main/GitHub_link/MarkerBatAcousticAnalyses/MarkerBatAcousticAnalyses2022"



### Here is some example code from Pierre that I would like to implement soon which allows us to adjust all the directories based on the user

# if(Sys.info()['user'] == 'pidu') {                                                                                                                                               ## Pierre
#   gitDir <- 'C:/myDocuments/AlpineWolf'
#   dataDir <- 'C:/Users/pidu/Dropbox (AQEG)/AQEG Team Folder/AlpineWolf/01_Data'  
#   analysisDir <- 'C:/Users/pidu/Dropbox (AQEG)/AQEG Team Folder/AlpineWolf/02_Analysis'
#   simulationDir <- 'C:/Users/pidu/Dropbox (AQEG)/AQEG Team Folder/AlpineWolf/03_Simulations'
#   meetingDir <- 'C:/Users/pidu/Dropbox (AQEG)/AQEG Team Folder/AlpineWolf/04_Meetings'
#   reportDir <- 'C:/Users/pidu/Dropbox (AQEG)/AQEG Team Folder/AlpineWolf/06_Report'
# } else if(Sys.info()['user'] == 'virginia') {                                                                                                                                ## Virginia
#   gitDir <- '/Users/virginia/Dropbox/Mac/Documents/GitHub/AlpineWolf'
#   dataDir <- '/Users/virginia/Dropbox/AlpineWolf/01_Data'
#   analysisDir <- '/Users/virginia/Dropbox/AlpineWolf/02_Analysis'
#   simulationDir <- '/Users/virginia/Dropbox/AlpineWolf/03_Simulations'
#   meetingDir <- '/Users/virginia/Dropbox/AlpineWolf/04_Meetings'
#   reportDir <- '/Users/virginia/Dropbox/AlpineWolf/06_Report'
# 

##########################################################
#### Work environment set up ####
##########################################################
library(knitr)
library(data.table)
library(tidyverse)
library(beepr)
library(lubridate)
library(purrr)
#renv::install("rstudio/renv")
library(renv)
library(stringr)
library(janitor)
library(anytime)
library(kableExtra)
library(papeR)
library(skimr)
library(vtable)
library(gratia)
library(DHARMa)
library(mgcv)
library(tidymv)

##########################################################
#### Import data, set up directories   ####
##########################################################

# All input data can be found on a shared OneDrive folder - we can both share the same input folder but we should have different Output folders. 

# for Katrine 
#input <- ""

# for Reed 
input <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/2. Marker 2019-2020/Marker 2022/SecondDraftAnalyses/Input/forModels"

dataset1 <- "guild_behavior_summarytable_site.csv" 
# df2C for the dataset aggregated by guild and bahavior from Marker aggregated to night_all bats
dataset2 <- "totalbatpass_summarytable_withbinary_batpass_night_aggregated_site data.csv"
# df2C for the dataset aggregated to all batsa from Marker aggregated to night_all bats
dataset3 <- "nightlyaggregated_zeros_binary_behavior and guild.csv"
# dataset aggregated to guild and behavior before being table transformed 
dataset4 <- "nightlyaggregatedMarker2020_totalbats_zeroinserted_weather_binary.csv"
# dataset aggregated to night by total bats before table transformed 
dataset5 <- "guild_behavior_batpass_summarytable_trimmed MRE social and met tower.csv"


path1 <- str_c(input, "/", dataset1)
path2 <- str_c(input, "/", dataset2)
path3 <- str_c(input, "/", dataset3)
path4 <- str_c(input, "/", dataset4)
path5 <- str_c(input, "/", dataset5)

bats_gb <- read_csv(path1) # 11412 obs of 20 variables 
bats_tot <- read.csv(path2) # # 951 obs of 18 variables variables
bats_gb_simple <- read.csv(path3) # 11412 obs of 17 vars 
bats_tot_simple <- read.csv(path4) # 951 obs of 15 variables
bats_gb_trim <- read.csv(path5) # 4866 obs of 20 variables 

# for Reed
output <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/2. Marker 2019-2020/Marker 2022/SecondDraftAnalyses/Reed/Outputs"

# for Katrine 
#output <- ""

## 
 file.name <- "Step3.Marker bat acoustics models draft 2"
# 
 todays_date <- Sys.Date()
# 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
 dir.name
# 
# dir.create(dir.name) # be careful not to recreate existing directories 

output_today <- dir.name
output_today

```

### Recommended Youtube videos on GAM to understand the R code below

 https://www.youtube.com/watch?v=q4_t8jXcQgc
 https://www.youtube.com/watch?v=sgw4cu8hrZM&t=4038s
 
--------------------------------------------------------------------------------

The "bats_tot" dataset 
Nightly aggregated total bat activity 

# Preparing the dataset for modeling 
Starting with bats total 
```{r, echo = FALSE}
str(bats_tot) #Seems like our factor variables are back to 'chr' variables again....
names(bats_tot)
#Housekeeping to make character variables factors
bats_tot$Habitat <- factor(bats_tot$Habitat)
bats_tot$Locality <- factor(bats_tot$Locality)
bats_tot$Site <- factor(bats_tot$Site)
bats_tot$Facility <- factor(bats_tot$Facility) 
bats_tot$jnight <- yday(bats_tot$night)

#Explore relationships and look check for outliers again
par(mfrow = c(3,2))
plot(bats_tot$jnight, bats_tot$batpass_prop)            
plot(bats_tot$temp_mean, bats_tot$batpass_prop)
plot(bats_tot$temp_max, bats_tot$batpass_prop)
plot(bats_tot$wind_mean, bats_tot$batpass_prop)
plot(bats_tot$wind_max, bats_tot$batpass_prop)

hist(bats_tot$Batpass_sum)# This goes out to 700 ish bat passes per night. For modeling with count data, should make a bat pass50 column to work with. 

#The batspass_prop variable is "number of hours with >0 batpass" / "total number of observation hours" - per night
#This is your response, but often proportion variables cannot be modelled directly 
```
 
### Steps to prepare binary response (1=batpass, 0 = no batpass)
```{r}
# This is now only nightly aggregated so I am not sure this has the same intended effect... 

bats_tot$yes_batpass <- bats_tot$batpass01_sum   #batpass01_sum is sum of '1' values in batpass01, i.e. number of observ. hours per night when batpass recorded
bats_tot$no_batpass <- bats_tot$batpass01_length - bats_tot$batpass01_sum #batpass01_length is number of observ. hours per night

summary(bats_tot)

```

Fitting he full model (I recommend not making the model more complex than this)
Will have to do trial-and-error to get the k right

```{r}
m1 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       #bs = "re" is equivalent to adding Locality as random intercept in a mixed model (GAMM)
              s(jnight, by = Habitat, bs = "gp", k =90) +    #allows for separate shapes of relationships with jnight for each habitat, bs = "gp" takes care of temporal autocorrelation
              Habitat +                                      #main effect of habitat (testing if means differ between habitats)
              s(temp_mean) +                                 #does not seem to make much difference whether I use max or mean temp, so I chose mean (feels less like cherry-picking, I think...)
              s(wind_mean) +                                 #same as for temp
              ti(temp_mean,wind_mean) ,                      #interaction between temp and wind
              data = bats_tot, method = "REML",                  #REML is not default, but is highly recommended by experts
              family = binomial, select=TRUE)                #may have to shift to quasibinomial if overdispersion, select = TRUE gives you automatic model selection

summary(m1) # not *quite* all terms significant - not Locality or jnight*Habitat 
# output below 
```

### Katrine: 
The reason why I use GAM with a rather simple random effect instead of GAMM, is that there are fewer options (e.g., distributions) available in GAMM

Model validation (may also use dHARMA to get more fancy validation plots)
Note that validation if binomial models is usually a pain and does not give meaningful validation plots
However, it works in our case, because of the aggregated nature of the data :-)
I found a similar example in https://www.youtube.com/watch?v=sgw4cu8hrZM&t=4038s 


```{r}
par(mfrow = c(2,2))
gam.check(m1)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m1, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

overdispersion.m1 <- sum( residuals(m1, "pearson")^2 ) / m1$df.residual
overdispersion.m1
# 0.80653 - looking good! 

## Not overdispersed but the k values are off. 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```

### Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}
bmp(file.path(output_today, "checking k dimensions m1 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m1, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m1, scales ="free")         #function 'draw' is from package 'gratia'
draw(m1, scales ="fixed")

dev.off() 

## Visualize the 3D GAM
bmp(file.path(output_today, "3D gam m1 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))

vis.gam(m1, view = c("temp_mean", "wind_mean"))    #Not a very elegant plot, you can find prettier solutions, but helps understand the interaction between temp and wind
vis.gam(m1, view = c("wind_mean", "temp_mean")) 

dev.off()

vis.gam(m1, view = c("temp_mean", "wind_mean"))    
vis.gam(m1, view = c("wind_mean", "temp_mean")) 




```

--------------------------------------------------------------------------------

# m2 
### model temperature as linear effect

```{r}
m2 <- gam(cbind(yes_batpass,no_batpass) ~
            s(Locality, bs = "re") +                      
            s(jnight, by = Habitat, bs = "gp", k =90) +    
            Habitat +                                      
            temp_mean +                                 
            s(wind_mean) +                                 
            ti(temp_mean,wind_mean) ,                      
          data = bats_tot, method = "REML",                  
          family = binomial, select=TRUE)              
summary(m2) 

```

Only ti(temp_mean, wind_mean) is significant...

### Basis dimension (k) checking results: 
```{r}

par(mfrow = c(2,2))
gam.check(m2)
gam.check(m2, rep=500)  

### Interpreting gam.check() output
## First check if the model converges - this does after 18 iterations!
## If it didn't then the results would not be meaningful 
## Now each smooth term is evaluated to see if the residuals of these terms are randomly distributed. 
## If the p value is low for a smooth term, then the residuals are not random and most likely the K value should be increased. 
## In this case, the p value of tensor product interaction term (ti) for  temp and mean is very low and the current k value is 16. Notice that the other k values on the smooth terms are either 9 or close to 90. 
## Tensor product smooths and interaction, playing with k for these types of terms in not the same as for normal smooth terms... need to specify both the k-values i.e. k = c(4,5) 

## quick rundown on some of the lexicon behind tensor terms: 
#   te() is like x*Z or x + z + x:z if you want to write it all out
#   ti() is like X:Z only
## 

overdispersion.m2 <- sum( residuals(m2, "pearson")^2 ) / m2$df.residual
overdispersion.m2 
# Now at [1] 0.7804294, a bit under dispersed. 


```

### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m2 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m2, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m2, scales ="free")         #function 'draw' is from package 'gratia'
draw(m2, scales ="fixed")

dev.off() 

## Visualize the 3D GAM
bmp(file.path(output_today, "3D gam m2 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m2, view = c("temp_mean", "wind_mean"))    
vis.gam(m2, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m2, view = c("temp_mean", "wind_mean"))    
vis.gam(m2, view = c("wind_mean", "temp_mean")) 

```

## Recap

This model is more under dispersed than the last one and the issue of an ill-fitting k value is still there.

summary(m1) # R-sq.(adj) =  0.365   Deviance explained = 37.4%
summary(m2) # R-sq.(adj) =  0.369   Deviance explained = 37.5%

However, this doesn't seems to make a huge difference in the overall fit of the model to the data 

Changing the the mean temperature term to a linear variable doesn't appear to make a huge difference on the model fit, if anything it is a slightly poorer fit of the data. So I will keep this as a smooth term and adjust k values on the ti(temp_mean, wind_mean term instead)


Some notes from Katrine: 

<!-- See "Step 3B GAM modelling.R" script for examples of pruning the data to make it a bit easier to work with. 

<!-- #But it is really a hassel to have to predict for levels of Locality... -->
<!-- #One trick is to swap Loaclity with Facility in the mp model and refit the model -->
<!-- #Then you get away with predicting for Facility South (or North) -->
<!-- #But there is a way of excluding terms when predicting, see: https://cran.r-project.org/web/packages/tidymv/vignettes/predict-gam.html -->
<!-- #But I have not had time to figure this out yet. -->

--------------------------------------------------------------------------------

# m3 
### Model temperature as linear effect, assign higher k values to the ti() term 

```{r}
m3 <- gam(cbind(yes_batpass,no_batpass) ~
            s(Locality, bs = "re") +                      
            s(jnight, by = Habitat, bs = "gp", k =90) +    
            Habitat +                                      
            s(temp_mean) +                                 
            s(wind_mean) +                                 
            ti(temp_mean,wind_mean, k = c(10, 10)) ,                      
          data = bats_tot, method = "REML",                  
          family = binomial, select=TRUE)              
summary(m3) 

```


```{r}

par(mfrow = c(2,2))
gam.check(m3)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m3, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m3 <- sum( residuals(m3, "pearson")^2 ) / m3$df.residual
overdispersion.m3
# 0.8053636 - looking good! However, the k index on the ti() term is still off. 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}
#plot(m1, pages=1,scheme=2,shade=TRUE)
bmp(file.path(output_today, "checking k dimensions m3 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m3, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m3, scales ="free")         #function 'draw' is from package 'gratia'
draw(m3, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m3 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m3, view = c("temp_mean", "wind_mean"))    #Not a very elegant plot, you can find prettier solutions, but helps understand the interaction between tempp and wind
vis.gam(m3, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m3, view = c("temp_mean", "wind_mean"))    #Not a very elegant plot, you can find prettier solutions, but helps understand the interaction between tempp and wind
vis.gam(m3, view = c("wind_mean", "temp_mean"))





```

--------------------------------------------------------------------------------

# m4 
### Try once more with slightly lower k values for the ti() term 

```{r}
m4 <- gam(cbind(yes_batpass,no_batpass) ~
            s(Locality, bs = "re") +                      
            s(jnight, by = Habitat, bs = "gp", k =90) +    
            Habitat +                                      
            s(temp_mean) +                                 
            s(wind_mean) +                                 
            ti(temp_mean,wind_mean, k = c(15, 15)) ,                      
          data = bats_tot, method = "REML",                  
          family = binomial, select=TRUE)              
summary(m4) # R-sq.(adj) =  0.407   Deviance explained =   43%

```


```{r}

par(mfrow = c(2,2))
gam.check(m4)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m4, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m4 <- sum( residuals(m4, "pearson")^2 ) / m4$df.residual
overdispersion.m4
# 0.5971965 - super duper under dispersed , but the fit of the k value is slightly better. 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m4 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m4, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m4, scales ="free")         #function 'draw' is from package 'gratia'
draw(m4, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m4 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m4, view = c("temp_mean", "wind_mean"))    
vis.gam(m4, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m4, view = c("temp_mean", "wind_mean"))    
vis.gam(m4, view = c("wind_mean", "temp_mean")) 

```


# m8
### Bats total dataset
### Adjust the k value of  s(jnight, by = Habitat, bs = "gp") to k = 15

```{r}

m8 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k = 15) +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean, k = c(20,20)) ,                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m8) 
```


```{r}

par(mfrow = c(2,2))
gam.check(m8)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m8, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m8 <- sum( residuals(m8, "pearson")^2 ) / m8$df.residual
overdispersion.m8
# 0.5588888 - The k indices look okay, but still under dispersed

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```

### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m8 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m8, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m8, scales ="free")         #function 'draw' is from package 'gratia'
draw(m8, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m8 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m8, view = c("temp_mean", "wind_mean"))    
vis.gam(m8, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m8, view = c("temp_mean", "wind_mean"))    
vis.gam(m8, view = c("wind_mean", "temp_mean")) 

```

## Recap:
This slightly improved the overall model fit, so I will keep this model but add another manual k term to the s(wind_mean) term. 

--------------------------------------------------------------------------------

# m9
### Adjust the k value of  s(jnight, by = Habitat, bs = "gp") to k = 15

```{r}

m9 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k = 15) +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean, k = 20) +                                
              ti(temp_mean,wind_mean, k = c(20,20)) ,                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m9) 
```


```{r}

par(mfrow = c(2,2))
gam.check(m9)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m9, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m9 <- sum( residuals(m9, "pearson")^2 ) / m9$df.residual
overdispersion.m9
# 0.566872 - The k indices look okay, but still under dispersed

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m9 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m9, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m9, scales ="free")         #function 'draw' is from package 'gratia'
draw(m9, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m9 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m9, view = c("temp_mean", "wind_mean"))    
vis.gam(m9, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m9, view = c("temp_mean", "wind_mean"))    
vis.gam(m9, view = c("wind_mean", "temp_mean")) 

```

This slightly improved the overall model fit, but still have the same issues overall. 
--------------------------------------------------------------------------------

# m10
### Adjust ti(temp_mean,wind_mean, k = c(25,25))
```{r}

m10 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k = 15) +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean, k = 20) +                                
              ti(temp_mean,wind_mean, k = c(25,25)) ,                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m10) 
```


```{r}

par(mfrow = c(2,2))
gam.check(m10)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m10, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m10 <- sum( residuals(m10, "pearson")^2 ) / m10$df.residual
overdispersion.m10
# 0.6045513 - The k indices look okay, but still under dispersed - though not as bad as before! 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```

### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m10 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m10, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m10, scales ="free")         #function 'draw' is from package 'gratia'
draw(m10, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m10 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m10, view = c("temp_mean", "wind_mean"))    
vis.gam(m10, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m10, view = c("temp_mean", "wind_mean"))    
vis.gam(m10, view = c("wind_mean", "temp_mean")) 

```

--------------------------------------------------------------------------------

# m14
### s(Facility, bs = "re") rather than Locality 
```{r}
m14 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean) ,                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m14) 

```


```{r}
#windows()
par(mfrow = c(2,2))
gam.check(m14)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m14, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m14 <- sum( residuals(m14, "pearson")^2 ) / m14$df.residual
overdispersion.m14
# 0.8134479 - under dispersion is fixed by the k values are still not good

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```

### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m14 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m14, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m14, scales ="free")         #function 'draw' is from package 'gratia'
draw(m14, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m14 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m14, view = c("temp_mean", "wind_mean"))    
vis.gam(m14, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m14, view = c("temp_mean", "wind_mean"))    
vis.gam(m14, view = c("wind_mean", "temp_mean")) 

```

Using facility rather than locality as a random effect did not seem to make much a difference, can try it again once more with adjusting the k values for the ti() term. 
--------------------------------------------------------------------------------

# m15
### s(Facility, bs = "re") rather than Locality 
```{r}
m15 <- gam(cbind(yes_batpass,no_batpass) ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean, k = c(20,20)) ,                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m15) 

```


```{r}

par(mfrow = c(2,2))
gam.check(m15)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m15, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m15 <- sum( residuals(m15, "pearson")^2 ) / m15$df.residual
overdispersion.m15
# 0.574884 - under dispersion is there and the k values are still not good

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m15 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m15, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m15, scales ="free")         #function 'draw' is from package 'gratia'
draw(m15, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m15 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m15, view = c("temp_mean", "wind_mean"))    
vis.gam(m15, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m15, view = c("temp_mean", "wind_mean"))    
vis.gam(m15, view = c("wind_mean", "temp_mean")) 

```

I am not sure what else to do at this point other than use a different response variable. 
# try batpass_prop

--------------------------------------------------------------------------------

# m16
### y = batpass_prop
### s(Facility, bs = "re") rather than Locality 
```{r}
m16 <- gam(batpass_prop ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean),                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m16) 

```


```{r}

par(mfrow = c(2,2))
gam.check(m16)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m16, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m16 <- sum( residuals(m16, "pearson")^2 ) / m16$df.residual
overdispersion.m16
# 0.8134479 - under dispersion is there and the k values are still not good

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m16 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m16, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m16, scales ="free")         #function 'draw' is from package 'gratia'
draw(m16, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m16 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m16, view = c("temp_mean", "wind_mean"))    
vis.gam(m16, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m16, view = c("temp_mean", "wind_mean"))    
vis.gam(m16, view = c("wind_mean", "temp_mean")) 

```

--------------------------------------------------------------------------------

# m17
### s(Facility, bs = "re") rather than Locality 
```{r}
m17 <- gam(batpass_prop ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean, k = c(20,20)) ,                      
              data = bats_tot, method = "REML",                 
              family = binomial, select=TRUE)                

summary(m17) 

```


```{r}

par(mfrow = c(2,2))
gam.check(m17)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m17, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m17 <- sum( residuals(m17, "pearson")^2 ) / m17$df.residual
overdispersion.m17
# 0.574884 - under dispersion is there and the k values are still not good

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m17 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m17, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m17, scales ="free")         #function 'draw' is from package 'gratia'
draw(m17, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m17 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m17, view = c("temp_mean", "wind_mean"))    
vis.gam(m17, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m17, view = c("temp_mean", "wind_mean"))    
vis.gam(m17, view = c("wind_mean", "temp_mean")) 

```

This did not help, it seems like ti(temp_mean,wind_mean) is the main issue regardless of what I do. 

I am going to switch to using a negative binomial model. 


# Troubelshooting under dispersed binomial gams with random effects 
Making a higher k value can help with improving the model fit but it tends to lead to underdispersion in this case. Removing the met tower data makes the models easier to work with. 

To Address under dispersion in binary GAMs:

https://dergipark.org.tr/en/download/article-file/922496 
This article suggests using an extended Altham distribution (EAD) family for under dispersed binomial count data- 
however I cannot find any commands in the mgcv package that will allow me to call that distribution.

The MM package does have the option to use this family but before changing packages, it is perhaps wiser to try and use counts as a response variable 

https://cran.r-project.org/web/packages/MM/vignettes/Gianfranco.pdf 


--------------------------------------------------------------------------------

# m18
### try model 1 with a negative binomial gamily insead of typical binomail
### Response variable = Batpass_sum
```{r}
m18 <- gam(Batpass_sum ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean) ,                      
              data = bats_tot, method = "REML",                 
              family = nb(), select=TRUE)                

summary(m18) 

```


```{r}

par(mfrow = c(2,2))
gam.check(m18)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m18, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m18 <- sum( residuals(m18, "pearson")^2 ) / m18$df.residual
overdispersion.m18
# 1.24094 - k indicies have simimlar issues but now we are overdispersed! 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m18 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m18, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m18, scales ="free")         #function 'draw' is from package 'gratia'
draw(m18, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m18 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m18, view = c("temp_mean", "wind_mean"))    
vis.gam(m18, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m18, view = c("temp_mean", "wind_mean"))    
vis.gam(m18, view = c("wind_mean", "temp_mean")) 

```

--------------------------------------------------------------------------------

# m19
### try model 1 with a negative binomial gamily insead of typical binomail
### Response variable = Batpass_sum
### Adjust the k value on ti(temp_mean,wind_mean)
```{r}
m19 <- gam(Batpass_sum ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean, k = c(25,25)) ,                      
              data = bats_tot, method = "REML",                 
              family = nb(), select=TRUE)                

summary(m19) 

```


```{r}
#windows()
par(mfrow = c(2,2))
gam.check(m19)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m19, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m19 <- sum( residuals(m19, "pearson")^2 ) / m19$df.residual
overdispersion.m19
# 1.119004 - dispersion is fine and the k values fit too! TADA! 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m19 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m19, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m19, scales ="free")         #function 'draw' is from package 'gratia'
draw(m19, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m19 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m19, view = c("temp_mean", "wind_mean"))    
vis.gam(m19, view = c("wind_mean", "temp_mean")) 
dev.off()

vis.gam(m19, view = c("temp_mean", "wind_mean"))    
vis.gam(m19, view = c("wind_mean", "temp_mean")) 

```
--------------------------------------------------------------------------------

# m20
### try model 1 with a negative binomial gamily insead of typical binomail
### Response variable = Batpass_sum
### Adjust the k value on ti(temp_mean,wind_mean)
### s(Locality, bs = "re")
```{r}
m20 <- gam(Batpass_sum ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean) +                                
              ti(temp_mean,wind_mean, k = c(25,25)) ,                      
              data = bats_tot, method = "REML",                 
              family = nb(), select=TRUE)                

summary(m20) 

```



```{r}
bmp(file.path(output_today, "diagnostic plots bats_tot m20.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(2,2))
gam.check(m20)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m20, rep=500)  #
dev.off()
# Now the smooth terms pass the basis dimension test! 

overdispersion.m20 <- sum( residuals(m20, "pearson")^2 ) / m20$df.residual
overdispersion.m20
# 1.150768 - dispersion is fine and the k values fit too! TADA! 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.150768    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m20 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m20, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m20, scales ="free")         #function 'draw' is from package 'gratia'
draw(m20, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 


bmp(file.path(output_today, "3D gam m20 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m20, view = c("temp_mean", "wind_mean"))    
vis.gam(m20, view = c("wind_mean", "temp_mean")) 
dev.off()

```

# Comparing m19 and m20

Both models perform similarily well at a glance, but how do they compare using BIC? 
```{r}

BIC(m19, m20)
#           df      BIC
# m19 75.88930 6612.675
# m20 84.26171 6535.970 
# the model with locality performs better, despite the higher degrees of freedom. 
# 
```


--------------------------------------------------------------------------------

# m21
### Facility rather than Locality as a random effect
### try something similar to model 20, with some slightly different smoother terms 
### Response variable = Batpass_sum
```{r}
summary(bats_tot$wind_mean)
summary(bats_tot$temp_mean)

#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   2.571   4.486   6.012   6.249   7.857  13.413 
# > summary(bats_tot$temp_mean)
#    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   8.789  13.419  14.930  15.647  17.494  24.579

# Trying with some slightly different smoother terms 

m21 <- gam(Batpass_sum ~
              s(Facility, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp") +    
              Habitat +                                     
              temp_mean +                                
              s(wind_mean, bs = "cc", k = 10) +                                
              ti(temp_mean,wind_mean, k = c(25,25), bs = "cc"),                      
              data = bats_tot, method = "REML",                 
              family = nb(), select=TRUE)                

summary(m21) 

```


```{r}

par(mfrow = c(2,2))
gam.check(m21)           #look at the plots, but also the output to check if k needs to be adjusted
gam.check(m21, rep=500)  #rep=500 gives you a polygon on the QQ plot, which the observed values should lie within

# Now the smooth terms pass the basis dimension test! 

overdispersion.m21 <- sum( residuals(m21, "pearson")^2 ) / m21$df.residual
overdispersion.m21
# 1.110624 - k indicies are fixed and no over / under dispersion 

# From Katrine's Step3B GAM modelling script: 
#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


### Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m21 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)

plot(m21, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m21, scales ="free")         #function 'draw' is from package 'gratia'
draw(m21, scales ="fixed")
# wind is too wiggly, but there is no relationship for the met tower(probably too little data...) 
dev.off() 

bmp(file.path(output_today, "3D gam m21 bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))
vis.gam(m21, view = c("temp_mean", "wind_mean"))    
vis.gam(m21, view = c("wind_mean", "temp_mean")) # still too wiggly though.... 
dev.off()

vis.gam(m21, view = c("temp_mean", "wind_mean"))    
vis.gam(m21, view = c("wind_mean", "temp_mean")) 

```

--------------------------------------------------------------------------------

--------------------------------------------------------------------------------

# Make prediction figures
### Better visualize the wind and temperature cutoffs

### May be helpful to reference later: 
https://cran.r-project.org/web/packages/tidymv/vignettes/plot-smooths.html
https://drmowinckels.io/blog/2019-11-16-plotting-gamm-interactions-with-ggplot2/
https://www.imsbio.co.jp/RGM/R_rdfile?f=itsadug/man/pvisgam.Rd&d=R_CC

```{r}

names(bats_tot)
# from this blog 
# https://drmowinckels.io/blog/2019-11-16-plotting-gamm-interactions-with-ggplot2/

# A few different ways to make predictions 

## option 1 

# library(itsadug)
# pvisgam(m21, view = c("wind_mean", "temp_mean"))

ct_int_pred <- expand.grid(temp_mean= c(8,10, 12, 14, 16, 18, 20),
                          wind_mean = c(2, 4, 6, 8, 10, 12),
                          Habitat = levels(bats_tot$Habitat),
                          Facility = "South",
                          jnight = seq(min(bats_tot$jnight), max(bats_tot$jnight), 1))

ct_int_pred1 <- predict(m21, newdata = ct_int_pred,
                      se.fit = TRUE) %>%
  as_tibble() %>%
  cbind(ct_int_pred)

############################################

# # option 2 

fit <- predict.gam(m21, newdata = ct_int_pred, type = "response")
ct_int_pred2 <- data.frame(ct_int_pred, fit)
summary(ct_int_pred2)

############################################
# Plotting predicitons 

ggplot(ct_int_pred1, aes(x=temp_mean, y=wind_mean)) +
  geom_tile(aes(fill = fit)) +
  geom_contour(aes(z = fit), colour = "white")

ct_int_pred1 %>%
  ggplot(aes(x=wind_mean, y=fit)) +
  geom_point(aes(colour=wind_mean)) + facet_wrap(~Habitat)

ct_int_pred1 %>%
  ggplot(aes(x=temp_mean, y=fit)) +
  geom_point(aes(colour=temp_mean)) + facet_wrap(~Habitat)
# 
# ## This still does not look all that great unfortunately 

ggplot(ct_int_pred2, aes(x=temp_mean, y=wind_mean)) +
  geom_tile(aes(fill = fit)) +
  geom_contour(aes(z = fit), colour = "white")

ct_int_pred2 %>%
  ggplot(aes(x=wind_mean, y=fit)) +
  geom_point(aes(colour=wind_mean)) + facet_wrap(~Habitat)

ct_int_pred2 %>%
  ggplot(aes(x=temp_mean, y=fit)) +
  geom_point(aes(colour=temp_mean)) + facet_wrap(~Habitat)

```

--------------------------------------------------------------------------------
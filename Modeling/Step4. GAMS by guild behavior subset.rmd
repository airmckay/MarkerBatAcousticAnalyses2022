---
title: "GAMS by guild behavior subset"
output:
  word_document: default
  html_document: default
date: "2022-12-02"
---

### Notes from meeting with Katrine 29.11.2022

<!-- 1. For the total bat data set, with y = binary nightly bat activity  -->
<!-- ------------------------------------------------------------------------------------ -->
<!-- a. Adjust the k value for the bats_tot model to find one that better suits the data -->
<!-- b. Illustrate the wind/temperature cutoffs.  -->
<!-- - At some point, it may be necessary to re-aggregate the weather data to Facility rather than across both facilities -->
------------------------------------------------------------------------------------

2. For the guild / behavior specific data sets 
------------------------------------------------------------------------------------
a. Find appropriate k values for each model type
b. Re run with y = bat pass count (bat pass sum, bat pass mean) rather than the binary response.
   - managed some version of this for all model sets 
c. Diagnose under dispersion where it exists 
d. Experiment with leaving out or including the interaction between wind and temperature 
   -    I did this for night and habitat more often 
e. Make figures that show the overall activity at the different sites across time (perhaps include the mean or median as an added line with CI's) 
   - Did not make it here 
------------------------------------------------------------------------------------

<!-- 3. For the bat / insect data -->
<!-- ------------------------------------------------------------------------------------ -->
<!-- a. Create continuous workflow from the bottom up and make it accessible on GitHub  -->
<!-- b. Have a dataset and a GitHub friendly R script that Katrine can use to start working with the data by 7. Dec  -->
------------------------------------------------------------------------------------

## Generally helpful links
https://fromthebottomoftheheap.net/2021/02/02/random-effects-in-gams/
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6542350/
https://typeset.io/papers/ordinal-regression-models-for-zero-inflated-and-or-over-16rgcdiks5


```{r, results = FALSE}

# set project working directory according to the user system info 
# Otherwise, all the data (inputs and outputs, including figures) can be stored on a shared OneDrive folder

user <- Sys.info()['effective_user'] 
user
# this should print your nmbu user name - "apmc" in my case. 

wd <- getwd()
wd

##########################################################
#### Work environment set up ####
##########################################################
library(knitr)
library(data.table)
library(tidyverse)
library(beepr)
library(lubridate)
library(purrr)
#renv::install("rstudio/renv")
library(renv)
library(stringr)
library(janitor)
library(anytime)
library(kableExtra)
library(papeR)
library(skimr)
library(vtable)
library(gratia)
library(DHARMa)
library(mgcv)
library(tidymv)

##########################################################
#### Import data, set up directories   ####
##########################################################

# All input data can be found on a shared OneDrive folder - we can both share the same input folder but we should have different Output folders. 

# for Katrine 
#input <- ""

# for Reed 
input <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/2. Marker 2019-2020/Marker 2022/SecondDraftAnalyses/Input/forModels"

dataset1 <- "guild_behavior_summarytable_site.csv" 
# df2C for the dataset aggregated by guild and bahavior from Marker aggregated to night_all bats
dataset2 <- "totalbatpass_summarytable_withbinary_batpass_night_aggregated_site data.csv"
# df2C for the dataset aggregated to all batsa from Marker aggregated to night_all bats
dataset3 <- "nightlyaggregated_zeros_binary_behavior and guild.csv"
# dataset aggregated to guild and behavior before being table transformed 
dataset4 <- "nightlyaggregatedMarker2020_totalbats_zeroinserted_weather_binary.csv"
# dataset aggregated to night by total bats before table transformed 
dataset5 <- "guild_behavior_batpass_summarytable_trimmed MRE social and met tower.csv"


path1 <- str_c(input, "/", dataset1)
path2 <- str_c(input, "/", dataset2)
path3 <- str_c(input, "/", dataset3)
path4 <- str_c(input, "/", dataset4)
path5 <- str_c(input, "/", dataset5)

bats_gb <- read_csv(path1) # 11412 obs of 20 variables 
bats_tot <- read.csv(path2) # # 951 obs of 18 variables variables
bats_gb_simple <- read.csv(path3) # 11412 obs of 17 vars 
bats_tot_simple <- read.csv(path4) # 951 obs of 15 variables
bats_gb_trim <- read.csv(path5) # 4866 obs of 20 variables 

# for Reed
output <- "C:/Users/apmc/OneDrive - Norwegian University of Life Sciences/2. Marker 2019-2020/Marker 2022/SecondDraftAnalyses/Reed/Outputs"

# for Katrine 
#output <- ""

## 
 file.name <- "Step4.GAMS by guild behavior subset"
# 
 todays_date <- Sys.Date()
# 
dir.name <- str_c(output,"/", file.name, "_", todays_date)
 dir.name
# 
 dir.create(dir.name) # be careful not to recreate existing directories 

output_today <- dir.name
output_today

```

### Recommended Youtube videos on GAM to understand the R code below

 https://www.youtube.com/watch?v=q4_t8jXcQgc
 https://www.youtube.com/watch?v=sgw4cu8hrZM&t=4038s
 
--------------------------------------------------------------------------------

# Prepate the datasets for modeling
Similar approach, now with 4 different data sets - 

LRE feeding
LRE commuting
SRE feeding
SRE commuting

Prepare new subsetted data
Take from bats_gb_trim (already removed met tower, MRE and social passes)'

```{r}
summary(bats_gb_trim)
bats_gb_trim$Habitat <- factor(bats_gb_trim$Habitat)
bats_gb_trim$Locality <- factor(bats_gb_trim$Locality)
bats_gb_trim$Site <- factor(bats_gb_trim$Site)
bats_gb_trim$Facility <- factor(bats_gb_trim$Facility)
bats_gb_trim$guild <- factor(bats_gb_trim$guild)
bats_gb_trim$behavior <- factor(bats_gb_trim$behavior)
bats_gb_trim$jnight <- yday(bats_gb_trim$night)

# binary effects 
bats_gb_trim$yes_batpass <- bats_gb_trim$batpass01_sum   #batpass01_sum is sum of '1' values in batpass01, i.e. number of observ. hours per night when batpass recorded
bats_gb_trim$no_batpass <- bats_gb_trim$batpass01_length - bats_gb_trim$batpass01_sum #batpass01_length is number of observ. hours per night

## addressing outliers for the count nightly bat pass
dotchart(bats_gb_trim$Batpass_sum)
hist(bats_gb_trim$Batpass_sum)
ggplot(bats_gb_trim) + geom_histogram(aes(x = Batpass_sum)) + xlim(c(1,100)) 
ggplot(bats_gb_trim) + geom_histogram(aes(x = Batpass_sum)) + xlim(c(1,50)) 
ggplot(bats_gb_trim) + geom_histogram(aes(x = Batpass_sum)) + xlim(c(0,50)) 
# Warning messages:
# 1: Removed 76 rows containing non-finite values (`stat_bin()`). 
# 2: Removed 2 rows containing missing values (`geom_bar()`). 
(4866-78)/4866*100
# lost less than 2 % of the observations by trimming data to 50 batpasses per night.
# Will convert batpasses over 50 to 50 and create a new column for it.

#Make a new column in the dataset
bats_gb_trim$batpass50 <- bats_gb_trim$Batpass_sum

# reassign batpass values over 50 to 50
bats_gb_trim$batpass50[bats_gb_trim$Batpass_sum>50] <- 50
## Do NOT use this for modelling 

```

# Survey effort

```{r}
survey.effort <- bats_gb_trim %>% 
  select(Site, night) %>% unique() 

survey.nights <- count(survey.effort, Site)

bats_gb_trim1 <- left_join(bats_gb_trim, survey.nights) %>% rename(survey.nights = n)
summary(bats_gb_trim1)
```

# Make guild - behavior subsets 
```{r}
summary(bats_gb_trim1)

LREf <- bats_gb_trim1 %>% filter(guild == "LRE", behavior == "Feeding") %>% droplevels()
LREc <- bats_gb_trim1 %>% filter(guild %in% "LRE", behavior %in% "Commuting") %>% droplevels()

SREf <- bats_gb_trim1 %>% filter(guild == "SRE", behavior == "Feeding") %>% droplevels()
SREc <- bats_gb_trim1 %>% filter(guild == "SRE", behavior == "Commuting") %>% droplevels()

summary(LREf) # 811 obs of 25 vars 
summary(LREc) # 811 obs of 25 vars 

summary(SREf) # 811 obs of 25 vars 
summary(SREc) # 811 obs of 25 vars 


## Number of bat passes in each dataset 
 sum(SREf$Batpass_sum)
#[1] 339
 sum(SREc$Batpass_sum)
#[1] 3776
 sum(LREf$Batpass_sum)
#[1] 3703
 sum(LREc$Batpass_sum)
#[1] 10584

# 339/3776
# 3703/10584

```


--------------------------------------------------------------------------------
# LRE feeding 
--------------------------------------------------------------------------------

# m1_LREf 

```{r}
m1_LREf <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       #bs = "re" is equivalent to adding Locality as random intercept in a mixed model (GAMM)
              s(jnight, by = Habitat, bs = "gp", k =90) +    
              Habitat +                                      
              temp_mean +                               
              s(wind_mean),                                 #same as for temp
              data = LREf, method = "REML",                  #REML is not default, but is highly recommended by experts
              family = binomial, select=TRUE)                #may have to shift to quasibinomial if overdispersion, select = TRUE gives you automatic model selection

summary(m1_LREf) # 

```

# Basic diagnostics 

```{r}
#
par(mfrow = c(2,2))
gam.check(m1_LREf, rep = 500)           

gam.check(m1_LREf)  



overdispersion.m1_LREf <- sum( residuals(m1_LREf, "pearson")^2 ) / m1_LREf$df.residual
overdispersion.m1_LREf


#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```

# Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m1_LREf bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

##
plot(m1_LREf, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m1_LREf, scales ="free")         
draw(m1_LREf, scales ="fixed")

dev.off() 

```

### Model recap 

The K terms are much better without the ti(temp_mean,wind_mean) term, though still a bit off. 
The dispersion is fine, however. This is good enough to make some predictions with at least. 

--------------------------------------------------------------------------------

## Making predictions
binary model, LRE feeding 

```{r}

names(LREf)
levels(LREf$Locality)
summary(LREf$wind_mean)
summary(LREf$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(LREf) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREf$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(LREf$jnight), max(LREf$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREf$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(LREf$jnight), max(LREf$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m1_LREf, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m1_LREf, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)




```

## Recap 

LRE bats are feeding similar amounts at the two different habitats but are using turbine pads slightly more, especially in late July / early August. 
 
--------------------------------------------------------------------------------

# m2_LREf - LRE feeding 
## negbinom / count response 
```{r}
m2_LREf <- gam(Batpass_sum ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k = 90) +    
              Habitat +                                      
              temp_mean +                               
              s(wind_mean, k = 15),                      
              data = LREf, method = "REML",                  
              family = nb())                  

summary(m2_LREf) # 

```

# Basic diagnostics 

```{r}

par(mfrow = c(2,2))
gam.check(m2_LREf, rep = 500)           

gam.check(m2_LREf)  



overdispersion.m2_LREf <- sum( residuals(m2_LREf, "pearson")^2 ) / m2_LREf$df.residual
overdispersion.m2_LREf



#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!


```

# Basis dimension (k) checking results: 

```{r}

bmp(file.path(output_today, "checking k dimensions m2_LREf bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

##
plot(m2_LREf, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m2_LREf, scales ="free")         
draw(m2_LREf, scales ="fixed")

dev.off() 

```

## Recap
LRE feeding, count response 
K values are terrible and the dispersion is borderline, I won't make predictions with this for now. 

--------------------------------------------------------------------------------

## Making predictions
binary model, LRE feeding 

```{r}

names(LREf)
levels(LREf$Locality)
summary(LREf$wind_mean)
summary(LREf$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(LREf) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREf$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(LREf$jnight), max(LREf$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREf$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(LREf$jnight), max(LREf$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m2_LREf, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m2_LREf, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)


```

## Recap

The difference between the two habitats being used as feeding habitat is most distinct in the middle of the season

--------------------------------------------------------------------------------
# LRE commuting 
--------------------------------------------------------------------------------

# m1_LREc  -  LRE commuting

```{r}
m1_LREc <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                      
              s(jnight, by = Habitat, bs = "gp", k = 90) +    
              Habitat +    
              temp_mean +
              s(wind_mean, k = 15), 
              data = LREc, method = "REML",                  
              family = binomial, select=TRUE)                

summary(m1_LREc) # 

```


```{r}
par(mfrow = c(2,2))
gam.check(m1_LREc)           
gam.check(m1_LREc, rep=500)  

## 

overdispersion.m1_LREc <- sum( residuals(m1_LREc, "pearson")^2 ) / m1_LREc$df.residual
overdispersion.m1_LREc



#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


# Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}

bmp(file.path(output_today, "checking k dimensions m1_LREc bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

plot(m1_LREc, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m1_LREc, scales ="free")         
draw(m1_LREc, scales ="fixed")

dev.off()
```

## Recap

The K values are pretty far off, even after adjusting them a few times, and the model is a bit under dispersed as well. Not incredible, but I will make some predictions with it. 


--------------------------------------------------------------------------------

## Making predictions
binary model, LRE commuting

```{r}

names(LREc)
levels(LREc$Locality)
summary(LREc$wind_mean)
summary(LREc$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(LREc) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREc$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(LREc$jnight), max(LREc$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREc$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(LREc$jnight), max(LREc$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m1_LREc, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m1_LREc, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)


```

## Recap

Not so surprisingly, these predictions closely resemble the total bat dataset models. 

--------------------------------------------------------------------------------


# m2_LREc  -  LRE commuting - Negbinom, y = Batpass_sum

```{r}
m2_LREc <- gam(Batpass_sum ~
              s(Locality, bs = "re") +                      
              s(jnight, by = Habitat, bs = "gp", k = 90) +    
              Habitat +                                      
              temp_mean +                               
              s(wind_mean, k = 15) ,                      
              data = LREc, method = "REML",                   
              family = nb(), select=TRUE)             

summary(m2_LREc) # 
 
```


```{r}
par(mfrow = c(2,2))
gam.check(m2_LREc)           
gam.check(m2_LREc, rep=500)  

## 

overdispersion.m2_LREc <- sum( residuals(m2_LREc, "pearson")^2 ) / m2_LREc$df.residual
overdispersion.m2_LREc



#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


# Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}

bmp(file.path(output_today, "checking k dimensions m2_LREc bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

plot(m2_LREc, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m2_LREc, scales ="free")         
draw(m2_LREc, scales ="fixed")

dev.off()

```


## Recap
### LRE commuting, count response 
K values are about the same as for the binary model but now the model is over dispersed. 

## Making predictions
count, LRE commuting

```{r}

names(LREc)
levels(LREc$Locality)
summary(LREc$wind_mean)
summary(LREc$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(LREc) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREc$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(LREc$jnight), max(LREc$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(LREc$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(LREc$jnight), max(LREc$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m2_LREc, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m2_LREc, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)


```

## Recap 

Can see more variation in the season but overall the relationship is the same 


--------------------------------------------------------------------------------
# SRE feeding
--------------------------------------------------------------------------------

# mr1_SREF
## Binary response 
```{r}

m1_SREf <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k =90) +
              Habitat +
              temp_mean +
              s(wind_mean, k = 15) ,                     
              data = SREf, method = "REML",                  
              family = binomial, select=TRUE)                

summary(m1_SREf) #

```


```{r}

par(mfrow = c(2,2))
gam.check(m1_SREf)           
gam.check(m1_SREf, rep=500) 

## 

overdispersion.m1_SREf <- sum( residuals(m1_SREf, "pearson")^2 ) / m1_SREf$df.residual
overdispersion.m1_SREf



#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


# Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}

bmp(file.path(output_today, "checking k dimensions m1_SREf bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

plot(m1_SREf, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m1_SREf, scales ="free")         
draw(m1_SREf, scales ="fixed")

dev.off() 

## Visualize the 3D GAM
bmp(file.path(output_today, "3D gam m1_SREf bats_tot.jpg"), width = 9, height = 6, units = "in", res = 350)
par(mfrow = c(1,2))

vis.gam(m1_SREf, view = c("temp_mean", "wind_mean"))    # Both are super duper wiggly 
vis.gam(m1_SREf, view = c("wind_mean", "temp_mean")) 

dev.off()
```

## Recap

The K values are actually in great shape but the model is a bit underdispersed. 
There is a flat relationship between night and habitat - probably because there are so few observations in this dataset. 


--------------------------------------------------------------------------------

## Making predictions
binary model, SRE feeding

```{r}

names(SREf)
levels(SREf$Locality)
summary(SREf$wind_mean)
summary(SREf$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(SREf) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREf$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(SREf$jnight), max(SREf$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREf$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(SREf$jnight), max(SREf$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m1_SREf, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m1_SREf, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)


# -----------------------------------------------------------------------------

## Other ways of visualizing this? 

```

## Recap

It is clear that there is more feeding activity predicted at natural habitats than at turbine habitats but nonsignificant effect of date and habitat makes the relationship difficult to compare to the other guild/behaviors.... what are some better ways to visualize this? 

--------------------------------------------------------------------------------

# mr2_SREf
## Count response 
```{r}

m2_SREf <- gam(Batpass_sum~
              s(Locality, bs = "re") + 
              Habitat + 
              s(jnight, by = Habitat, bs = "gp", k = 90) +
              temp_mean +
              s(wind_mean, k = 15),                     
              data = SREf, method = "REML",                  
              family = nb(), select=TRUE)                

summary(m2_SREf) #

```


```{r}
par(mfrow = c(2,2))
gam.check(m2_SREf)           
gam.check(m2_SREf, rep=500) 

## 

overdispersion.m2_SREf <- sum( residuals(m2_SREf, "pearson")^2 ) / m2_SREf$df.residual
overdispersion.m2_SREf



#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


# Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}

bmp(file.path(output_today, "checking k dimensions m2_SREf bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)
#
plot(m2_SREf, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m2_SREf, scales ="free")         
draw(m2_SREf, scales ="fixed")

dev.off()

```

## Recap

K values fit okay and the dispersion is not a problem. There is more of an effect for habitat and night in season, which is nice to see. The binary model performed pretty well overall though. I will make some predictions to see what they look like. 

--------------------------------------------------------------------------------

## Making predictions
count model, SRE feeding

```{r}

names(SREf)
levels(SREf$Locality)
summary(SREf$wind_mean)
summary(SREf$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(SREf) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREf$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(SREf$jnight), max(SREf$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREf$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(SREf$jnight), max(SREf$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m2_SREf, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m2_SREf, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

```

## Recap

The effect of natural habitat being the more selected habitat is strongest at the beginning of the season (July - ish)


--------------------------------------------------------------------------------
# SRE commuting 
--------------------------------------------------------------------------------


# mr1_SREc - Binary response, commuting 
```{r}

m1_SREc <- gam(cbind(yes_batpass,no_batpass) ~
              s(Locality, bs = "re") +                       
              s(jnight, by = Habitat, bs = "gp", k =90) +
              Habitat +
              temp_mean +
              s(wind_mean),                     
              data = SREc, method = "REML",                  
              family = binomial, select=TRUE)                

summary(m1_SREc) #

```


```{r}
par(mfrow = c(2,2))
gam.check(m1_SREc)           
gam.check(m1_SREc, rep=500) 

overdispersion.m1_SREc <- sum( residuals(m1_SREc, "pearson")^2 ) / m1_SREc$df.residual
overdispersion.m1_SREc



#[1] 1.022701    #this value should ideally be 0.8-1.2, but it's not very bad!

```


# Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}

bmp(file.path(output_today, "checking k dimensions m1_SREc bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

plot(m1_SREc, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m1_SREc, scales ="free")         
draw(m1_SREc, scales ="fixed")

dev.off()
```
## Recap
SRE commuting, binary 

The K values are a bit off but the dispersion is fine 
All response variables are significant except for the interaction between habitat and turbine pads 

--------------------------------------------------------------------------------

## Making predictions
binary model, SRE commuting

```{r}

names(SREc)
levels(SREc$Locality)
summary(SREc$wind_mean)
summary(SREc$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(SREc) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREc$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(SREc$jnight), max(SREc$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREc$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(SREc$jnight), max(SREc$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m1_SREc, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m1_SREc, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

```

## Recap 
The predicitions are easy enough to interpret and look good! 


--------------------------------------------------------------------------------


# mr2_SREc, Count response 

```{r}

m2_SREc <- gam(Batpass_sum ~
              s(Locality, bs = "re") +
              s(jnight, by = Habitat, bs = "gp", k =90) +
              Habitat +
              temp_mean +
              s(wind_mean, k = 15),                     
              data = SREc, method = "REML",                  
              family = nb(), select=TRUE)                

summary(m2_SREc) #

```


```{r}

par(mfrow = c(2,2))
gam.check(m2_SREc)           
gam.check(m2_SREc, rep=500) 

overdispersion.m2_SREc <- sum( residuals(m2_SREc, "pearson")^2 ) / m2_SREc$df.residual
overdispersion.m2_SREc





```


# Basis dimension (k) checking results: 
The k-index should be approx. 1 or larger
Play play around with k....

```{r}

bmp(file.path(output_today, "checking k dimensions m2_SREc bats_tot.jpeg"), width = 9, height = 6, units = "in", res = 350)

plot(m2_SREc, pages=1,scheme=2,shade=TRUE,seWithMean = TRUE)

draw(m2_SREc, scales ="free")         
draw(m2_SREc, scales ="fixed")

dev.off()

```

## Recap
K values are off by quite a bit and the model is over dispersed. The binary model definitely behaved 

--------------------------------------------------------------------------------

## Making predictions
count model, SRE commuting

```{r}

names(SREc)
levels(SREc$Locality)
summary(SREc$wind_mean)
summary(SREc$temp_mean)
# Quick summary in the differences in bat activity recorded at the different sites
ggplot(SREc) + geom_bar(aes(x=Site, y = Batpass_sum), stat = "identity") 

# -----------------------------------------------------------------------------
# Wind and temperature are fixed

# Turbine 9
newdata1 <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREc$Habitat),
                          Locality = "Turbine9",
                          jnight = seq(min(SREc$jnight), max(SREc$jnight), 1))
#Turbine 2
newdata1a <- expand.grid(temp_mean = 14,
                          wind_mean = 7,
                          Habitat = levels(SREc$Habitat),
                          Locality = "Turbine2",
                          jnight = seq(min(SREc$jnight), max(SREc$jnight), 1))
# ----------------------------------------------------------------------------

############################################
# # Fitting predictions
############################################

# Wind and temperature are fixed

# Turbine 9
fit1 <- predict.gam(m2_SREc, newdata = newdata1, se.fit = TRUE, type = "response")
fit1df <- data.frame(newdata1, fit1)
fit1df <- transform(fit1df, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1df)

# Turbine 2
fit1a <- predict.gam(m2_SREc, newdata = newdata1a, se.fit = TRUE, type = "response")
fit1adf <- data.frame(newdata1a, fit1a)
fit1adf <- transform(fit1adf, upper = fit + (2*se.fit), lower = fit-(2*se.fit))
summary(fit1adf)

```


## Comparing habitats across seasons
```{r}

# Turbine 9
fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line() + facet_wrap(~Habitat) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1df %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle("Turbine 9") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

# -----------------------------------------------------------------------------

# Turbine 2
fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
   geom_line() + facet_wrap(~Habitat) + ggtitle ("Turbine 2") +
   geom_ribbon(aes(ymin = lower, ymax = upper), fill = 'grey', alpha = 0.5)


fit1adf %>% ggplot(aes(x=jnight, y=fit)) +
  geom_line(aes(colour = Habitat)) + ggtitle ("Turbine 2") +
  geom_ribbon(aes(ymin = lower, ymax = upper, color = Habitat), fill = 'grey', alpha = 0.5)

```

## Recap 
Can see more variation in bat activity between the habitats than in the binary response model but overall the relationship is the same. 

# Rough sketch of rinal results 
```{r}

```

